<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>GPU cluster construction with Kubernetes (not yet completed) - akenji&#39;s lab</title>
  <meta name="description" content="Motivation I took on the challenge of creating a GPU cluster using multiple workstations I have set up at home to study Kubernetes. It was a hurdle for me, as I was new to Kubernetes. This is because I had to learn from the documentation whether the operations were necessary only during installation or when building the cluster (during operation). As it stands, the GPU cluster is not operational! This">
  <meta name="author" content="Kenji Arai"/><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "akenji\u0027s lab",
    
    "url": "https:\/\/akenji3.github.io"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https:\/\/akenji3.github.io"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "https:\/\/akenji3.github.io",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "https:\/\/akenji3.github.io\/en\/post\/20220821_kubernetes\/",
          "name": "G p u cluster construction with kubernetes (not yet completed)"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : "Kenji Arai"
  },
  "headline": "GPU cluster construction with Kubernetes (not yet completed)",
  "description" : "Motivation I took on the challenge of creating a GPU cluster using multiple workstations I have set up at home to study Kubernetes. It was a hurdle for me, as I was new to Kubernetes. This is because I had to learn from the documentation whether the operations were necessary only during installation or when building the cluster (during operation). As it stands, the GPU cluster is not operational! This",
  "inLanguage" : "en",
  "wordCount":  1747 ,
  "datePublished" : "2022-08-21T00:00:00",
  "dateModified" : "2022-08-21T00:00:00",
  "image" : "https:\/\/akenji3.github.io\/img\/avatar-icon.png",
  "keywords" : [ "cluster, kubernetes, gpu" ],
  "mainEntityOfPage" : "https:\/\/akenji3.github.io\/en\/post\/20220821_kubernetes\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "https:\/\/akenji3.github.io",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "https:\/\/akenji3.github.io\/img\/avatar-icon.png",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>

<meta property="og:title" content="GPU cluster construction with Kubernetes (not yet completed)" />
<meta property="og:description" content="Motivation I took on the challenge of creating a GPU cluster using multiple workstations I have set up at home to study Kubernetes. It was a hurdle for me, as I was new to Kubernetes. This is because I had to learn from the documentation whether the operations were necessary only during installation or when building the cluster (during operation). As it stands, the GPU cluster is not operational! This">
<meta property="og:image" content="https://akenji3.github.io/img/avatar-icon.png" />
<meta property="og:url" content="https://akenji3.github.io/en/post/20220821_kubernetes/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="akenji&#39;s lab" />

  <meta name="twitter:title" content="GPU cluster construction with Kubernetes (not yet completed)" />
  <meta name="twitter:description" content="Motivation I took on the challenge of creating a GPU cluster using multiple workstations I have set up at home to study Kubernetes. It was a hurdle for me, as I was new to Kubernetes. This is because …">
  <meta name="twitter:image" content="https://akenji3.github.io/img/avatar-icon.png" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@akenji3" />
  <meta name="twitter:creator" content="@akenji3" />
  <link href='https://akenji3.github.io/img/favicon.ico' rel='icon' type='image/x-icon'/>
  <meta name="generator" content="Hugo 0.74.3" />
  <link rel="alternate" href="https://akenji3.github.io/en/index.xml" type="application/rss+xml" title="akenji&#39;s lab"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"><link rel="stylesheet" href="https://akenji3.github.io/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="https://akenji3.github.io/css/highlight.min.css" /><link rel="stylesheet" href="https://akenji3.github.io/css/codeblock.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">



<meta name="google-site-verification" content="j8CZGVXeJvndIocFmzuHgNW2yAd7f30cM9gMYPGqDpE" />


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-TGXWYJXF48', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://akenji3.github.io/en/">akenji&#39;s lab</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Blog" href="/en">Blog</a>
            </li>
          
        
          
            <li>
              <a title="About" href="/en/page/about/">About</a>
            </li>
          
        
          
            <li>
              <a title="Categories" href="/en/categories">Categories</a>
            </li>
          
        
          
            <li>
              <a title="Tags" href="/en/tags">Tags</a>
            </li>
          
        

        
          
            <li>
              
                
              
                
                  <a href="/ja" lang="ja">ja</a>
                
              
            </li>
          
        

        
      </ul>
    </div>

    
      <div class="avatar-container">
        <div class="avatar-img-border">
          <a title="akenji&#39;s lab" href="https://akenji3.github.io/en/">
            <img class="avatar-img" src="https://akenji3.github.io/img/avatar-icon.png" alt="akenji&#39;s lab" />
          </a>
        </div>
      </div>
    

  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  

  <header class="header-section ">
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              
                <h1>GPU cluster construction with Kubernetes (not yet completed)</h1>
              
              
              
              
                <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on August 21, 2022
  
  
  
  
    
      &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;Kenji Arai
    
  
  &nbsp;&bull;&nbsp;Other languages: <a href="https://akenji3.github.io/post/20220821_kubernetes/" lang="ja">ja</a>
</span>


              
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        <h2 id="motivation">Motivation</h2>
<p>I took on the challenge of creating a GPU cluster using multiple workstations I have set up at home to study Kubernetes.</p>
<p>It was a hurdle for me, as I was new to Kubernetes. This is because I had to learn from the documentation whether the operations were necessary only during installation or when building the cluster (during operation).</p>
<p>As it stands, the GPU cluster is not operational!　This document is incomplete.</p>
<h2 id="sources">Sources.</h2>
<ul>
<li>
<p><a href="https://kubernetes.io/docs/home/">original document</a>
First, the document of the original source. The following is the part of the original document that I often refer to (mainly in Japanese).</p>
</li>
<li>
<p><a href="https://kubernetes.io/ja/docs/home/">Japanese version of the original document</a></p>
</li>
<li>
<p><a href="https://kubernetes.io/ja/docs/setup/production-environment/tools/kubeadm/install-kubeadm/">Japanese document: Installation of Kubeadm</a></p>
</li>
<li>
<p>[Original document: Creating a cluster using kubeadm](<a href="https://kubernetes.io/ja/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm">https://kubernetes.io/ja/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm</a> /)</p>
</li>
<li>
<p><a href="https://docs.nvidia.com/datacenter/cloud-native/kubernetes/install-k8s.html">Documentation from NVIDIA: Install Kubernetes</a>
I dared to use containerd as container runtime and installed it based on the &ldquo;containerd&rdquo; tag in the documentation.</p>
</li>
<li>
<p><a href="https://docs.nvidia.com/datacenter/cloud-native/gpu-operator/getting-started.html#install-nvidia-gpu-operator">NVIDIA documentation: NVIDIA GPU Operator</a></p>
</li>
<li>
<p><a href="https://qiita.com/yoshiono/items/4be595633d744e80ef7e">kubernetes v1.23.6/Nvidia GPUと戯れる; Playing with Kubernetes v1.23.6/Nvidia GPUs</a>
Uses Docker with Container Runtime, but has a wealth of valuable information.</p>
</li>
<li>
<p>A senior&rsquo;s document - A private installation document based on the above &ldquo;kubernetes v1.23.6/Nvidia GPUと戯れる; Playing with Kubernetes v1.23.6/Nvidia GPUs&rdquo;. Very well organized and easy to read.</p>
</li>
<li>
<p>[The Complete Guide to Kubernetes, 2nd Edition](<a href="https://www.amazon.co.jp/Kubernetes%E5%AE%8C%E5%85%A8%E3%82%AC%E3%82%A4%E3%83%89-%E7%AC%AC2%E7%89%88-Top-">https://www.amazon.co.jp/Kubernetes%E5%AE%8C%E5%85%A8%E3%82%AC%E3%82%A4%E3%83%89-%E7%AC%AC2%E7%89%88-Top-</a> Gear-%E9%9D%92%E5%B1%B1/dp/4295009792)
Recently purchased to use as a reference for future operations, etc.</p>
</li>
</ul>
<h2 id="installation-summary">Installation Summary</h2>
<h3 id="policies">Policies</h3>
<p>Proceed with the installation based on the above NVIDIA documentation. There are two parts to choose from, but I decided to install kubernetes with &ldquo;kubeadm&rdquo; and use &ldquo;NVIDIA GPU Operator&rdquo; for NVIDIA-related software. I have already installed driver and NVIDIA Container Toolkit in my environment.</p>
<p>Since the NVIDIA documentation is difficult to understand the connection (indentation), the following is a step-by-step procedure to see the whole installation process. (Each of the numbers roughly corresponds to each of the commands in the NVIDIA documentation.)</p>
<h3 id="environment">Environment</h3>
<p>The environment in which kubernetes is installed is shown in the following figure.</p>
<p>! <a href="/images/20220821_kubernetes/20220821_system_config.png">System Configuration</a></p>
<h3 id="installation-instructions">Installation Instructions</h3>
<h4 id="step-1-install-container-engine">Step 1: Install Container Engine</h4>
<h5 id="1-install-some-pre-requisites-packages-for-containerd">(1) Install some pre-requisites packages for containerd</h5>
<h5 id="2-configure-to-load-overlay-br_netfilter-kernel-modules">(2) Configure to load overlay, br_netfilter (kernel) modules</h5>
<h5 id="3-set-sysctl-parameters-in-conf-file">(3) Set sysctl parameters in conf file</h5>
<h5 id="4-configure-docker-repository">(4) configure Docker repository</h5>
<h5 id="5-install-containerd">(5) install containerd</h5>
<h5 id="6-set-containerd-default-parameters-in-configtoml-create">(6) Set containerd default parameters in config.toml (create)</h5>
<h5 id="7-modify-configtoml-so-that-containerd-uses-systemd-cgroup-driver">(7) Modify config.toml so that (containerd) uses systemd cgroup driver</h5>
<h5 id="8-restart-containerd-daemon">(8) Restart containerd daemon</h5>
<h4 id="step-2-install-kubernetes-components">Step 2: Install Kubernetes components</h4>
<h5 id="1-install-some-dependencies">(1) Install some dependencies</h5>
<h5 id="2-add-the-package-repository-keys">(2) Add the package repository keys</h5>
<h5 id="3-add-the-repository">(3) Add the repository</h5>
<h5 id="4-install-kubelet">(4) Install kubelet</h5>
<h5 id="5-note-no-1-configure-cgroup-driver-for-kuberlet">(5) Note no. 1: Configure cgroup driver for Kuberlet</h5>
<h5 id="6-note-no-2-restart-kubelet">(6) Note no. 2: Restart kubelet</h5>
<h5 id="7-disable-swap">(7) Disable swap</h5>
<h5 id="8-run-kubeadm-init">(8) Run kubeadm init</h5>
<h5 id="9-copy-authentication-files-under-home">(9) Copy authentication files under $HOME</h5>
<h4 id="step-3-configure-network">Step 3: Configure network</h4>
<h5 id="1-configure-network-in-calico">(1) Configure network in Calico</h5>
<h5 id="2-assign-the-worker-role-to-master-as-well">(2) Assign the worker role to master as well</h5>
<h4 id="step-4-setup-nvdia-software-using-nvidia-gpu-operator">Step 4: Setup NVDIA software (using NVIDIA GPU Operator)</h4>
<h5 id="1-install-helm">(1) Install helm</h5>
<h5 id="2-add-nvidia-helm-repository">(2) Add NVIDIA Helm repository</h5>
<h5 id="3-install-gpu-operator">(3) Install GPU Operator</h5>
<p>Now run the &ldquo;Containerd&rdquo; part of &ldquo;Bare-metal/Passthrough with pre-installed drivers and NVIDIA Container Toolkit&rdquo;.</p>
<h6 id="1-edit-configtoml">1) Edit config.toml</h6>
<h6 id="2-run-helm-install">2) Run helm install</h6>
<h5 id="4-confirm-gpu-operator-installation">(4) Confirm GPU Operator installation</h5>
<h5 id="5-run-sample-gpu-application">(5) Run sample GPU application</h5>
<h3 id="separate-master-control-plane-node-and-worker-node">Separate master (control plane) node and worker node</h3>
<p>The following shows which node to execute each step of the installation described in the previous section.</p>
<ul>
<li>
<p>Step 1: (1) to Step 2: (7)
Perform on any node, master or worker node.</p>
</li>
<li>
<p>Step 2: (8) - Step 2: (9)
Execute only on the master node; on the worker node, execute &ldquo;kuberadm join&rdquo;.</p>
</li>
<li>
<p>Step 3 and Step 4
Perform only on the master node.</p>
</li>
</ul>
<p>In the installation procedure, there is also a procedure to build a cluster in the kuberadm environment. This is described later.</p>
<h2 id="insul-operation">Insul operation</h2>
<h4 id="step-1-install-container-engine-1">Step 1: Install Container Engine</h4>
<h5 id="1-install-required-packages">(1) Install required packages</h5>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">sudo apt-get update<span class="se">\
</span><span class="se"></span>&gt; <span class="o">&amp;&amp;</span> sudo apt-get install -y apt-transport-https <span class="se">\
</span><span class="se"></span>&gt; ca-certificates curl software-properties-common
</code></pre></div><p>In my environment, all were the latest versions.</p>
<h5 id="2-set-to-load-overlay-br_netfilter-kernel-modules">(2) set to load overlay, br_netfilter (kernel) modules</h5>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ cat <span class="s">&lt;&lt;EOF | sudo tee /etc/modules-load.d/containerd.conf
</span><span class="s">&gt; overlay
</span><span class="s">&gt; br_netfilter
</span><span class="s">&gt; EOF</span>
$ sudo modprobe overlay <span class="se">\f</span>ilter
&gt; <span class="o">&amp;&amp;</span> sudo modprobe br_netfilter
</code></pre></div><h5 id="3-set-sysctl-parameters-in-conf-file-1">(3) Set sysctl parameters in conf file</h5>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ cat <span class="s">&lt;&lt;EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf
</span><span class="s">&gt; net.bridge.bridge-nf-call-iptables = 1
</span><span class="s">&gt; net.ipv4.ip_forward = 1
</span><span class="s">&gt; net.bridge.bridge-nf-call-ip6tables = 1
</span><span class="s">&gt; EOF</span>

$ sudo sysctl --system
</code></pre></div><h5 id="4-configure-docker-repository-1">(4) Configure Docker repository</h5>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ curl -fsSL https://download.docker.com/linux/ubuntu/gpg <span class="p">|</span> sudo apt-key --keyring /etc/apt/trusted.gpg.d/docker.gpg add -

$ sudo add-apt-repository <span class="s2">&#34;deb [arch=amd64] https://download.docker.com/linux/ubuntu \
</span><span class="s2">&gt; </span><span class="k">$(</span>lsb_release -cs<span class="k">)</span><span class="s2"> \
</span><span class="s2">&gt; stable&#34;</span>
</code></pre></div><h5 id="5-install-containerd-1">(5) install containerd</h5>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ sudo apt-get update <span class="se">\
</span><span class="se"></span>&gt; <span class="o">&amp;&amp;</span> sudo apt-get install -y containerd.io
</code></pre></div><p>In my environment, containerd.io had the latest version (1.6.7-1) already installed.</p>
<h5 id="6-set-default-parameters-for-containerd-by-creating-configtoml">(6) Set default parameters for containerd by (creating) config.toml</h5>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ sudo mkdir -p /etc/containerd <span class="se">\
</span><span class="se"></span>&gt; <span class="o">&amp;&amp;</span> sudo containerd config default <span class="p">|</span> sudo tee /etc/containerd/config.toml
</code></pre></div><p>Since containerd.io was already installed, the /etc/containerd directory and config.toml already existed. config.toml was renamed and saved.</p>
<h5 id="7-modify-configtoml-so-that-containerd-uses-systemd-cgroup-driver-1">(7) Modify config.toml so that (containerd) uses systemd cgroup driver</h5>
<p>Modify /etc/containerd/config.toml created above as follows.</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">125c125
&lt; <span class="nv">SystemdCgroup</span> <span class="o">=</span> <span class="nb">true</span>
---
&gt; <span class="nv">SystemdCgroup</span> <span class="o">=</span> <span class="nb">false</span>
</code></pre></div><h5 id="8-restart-containerd-daemon-1">(8) Restart containerd daemon</h5>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ sudo systemctl restart containerd
</code></pre></div><h4 id="step-2-install-kubernetes-components-1">Step 2: Install Kubernetes components</h4>
<h5 id="1-install-some-dependencies-1">(1) Install some dependencies</h5>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ sudo apt-get update <span class="se">\
</span><span class="se"></span>&gt; <span class="o">&amp;&amp;</span> sudo apt-get install -y apt-transport-https curl
</code></pre></div><p>The latest version was installed in my environment.</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg <span class="p">|</span> sudo apt-key add -
</code></pre></div><h5 id="2-add-repository-key">(2) Add repository key.</h5>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg <span class="p">|</span> sudo apt-key add -
</code></pre></div><h5 id="3-add-repository">(3) Add repository</h5>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ cat <span class="s">&lt;&lt;EOF | sudo tee /etc/apt/sources.list.d/kubernetes.list
</span><span class="s">&gt; deb https://apt.kubernetes.io/ kubernetes-xenial main
</span><span class="s">&gt; EOF</span>
</code></pre></div><h5 id="4-install-kubelet-1">(4) Install kubelet</h5>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ sudo apt-get update <span class="se">\
</span><span class="se"></span>&gt; <span class="o">&amp;&amp;</span> sudo apt-get install -y -q kubelet kubectl kubeadm
</code></pre></div><h5 id="5-note-1-configure-cgroup-driver-for-kuberlet">(5) Note 1: Configure cgroup driver for Kuberlet</h5>
<p>In the NVIDIA documentation, section 1 of Note.</p>
<p>At this point, 10-kubeadm.conf already exists under /etc/systemd/system/kuberlet.service.d.</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ sudo cat <span class="s">&lt;&lt; EOF | sudo tee /etc/systemd/system/kubelet.service.d/0-containerd.conf
</span><span class="s">&gt; [Service]
</span><span class="s">&gt; Environment=&#34;KUBELET_EXTRA_ARGS=--container-runtime=remote --runtime-request-timeout=15m --container-runtime-endpoint=unix:///run/containerd/containerd.sock --cgroup-driver=&#39;systemd&#39;&#34;
</span><span class="s">&gt; EOF</span>
</code></pre></div><h5 id="6-note-2-restart-kubelet">(6) Note 2: Restart kubelet</h5>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ sudo systemctl daemon-reload <span class="se">\
</span><span class="se"></span>&gt; <span class="o">&amp;&amp;</span> sudo systemctl restart kubelet
</code></pre></div><h5 id="7-disable-swap-1">(7) Disable swap</h5>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ swapon --show
NAME TYPE SIZE USED PRIO
/swapfile file 2G 0B -2
$ sudo swapoff -a
$ swapon --show
$
</code></pre></div><p>The above operation is temporary, and swap is enabled again when the server is restarted.
To disable it permanently, insert # at the beginning of any line in /etc/fstab that contains &ldquo;swap&rdquo; to disable it.  (In my environment, the line starts with /swapfile)</p>
<h5 id="8-run-kubeadm-init-1">(8) Run kubeadm init</h5>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ sudo kubeadm init --pod-network-cidr<span class="o">=</span>192.168.0.0/16
<span class="o">[</span>init<span class="o">]</span> Using Kubernetes version: v1.24.3
... Omitted. ...
Then you can join any number of worker nodes by running the following on each as root:

kubeadm join 192.168.11.3:6443 --token 7ffwr1.xm119vzqvmhqgevl <span class="se">\
</span><span class="se"></span>	--discovery-token-ca-cert-hash sha256:5d2f3065e38020b668ba1b766d95aea197182e35143511db7062f247f12c81d3 
$
</code></pre></div><p>Make a note of this part &ldquo;kubeadm join &hellip; sha256&hellip;&rdquo;. You can create a cluster as a woker node by executing the following:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ sudo kubeadm join 192.168.11.3:6443 --token 7ffwr1.xm119vzqvmhqgevl <span class="se">\
</span><span class="se"></span>&gt; --discovery-token-ca-cert-hash sha256:5d2f3065e38020b668ba1b766d95aea197182e35143511db7062f247f12c81d3 
<span class="o">[</span>preflight<span class="o">]</span> Running pre-flight checks
... Omitted...
This node has joined the cluster:
* Certificate signing request was sent to apiserver and a response was received.
* The Kubelet was informed of the new secure connection details.

Run <span class="s1">&#39;kubectl get nodes&#39;</span> on the control-plane to see this node join the cluster.
</code></pre></div><h5 id="9-copy-authentication-files-under-home-1">(9) Copy authentication files under $HOME</h5>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ mkdir -p <span class="nv">$HOME</span>/.kube <span class="se">\
</span><span class="se"></span>&gt; <span class="o">&amp;&amp;</span> sudo cp -i /etc/kubernetes/admin.conf <span class="nv">$HOME</span>/.kube/config <span class="se">\
</span><span class="se"></span>&gt; <span class="o">&amp;&amp;</span> sudo chown <span class="k">$(</span>id -u<span class="k">)</span>:<span class="k">$(</span>id -g<span class="k">)</span> <span class="nv">$HOME</span>/.kube/config
</code></pre></div><h4 id="step-3-set-up-your-network">Step 3: Set up your network</h4>
<h5 id="1-configure-network-in-calico-1">(1) Configure network in Calico</h5>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml
</code></pre></div><h5 id="2-assign-the-worker-role-to-master-as-well-1">(2) Assign the worker role to master as well</h5>
<p>As the NVIDIA documentation says &ldquo;GPU Pods can be scheduled on the simplest single-node clusters&rdquo;, it is possible to schedule a Pod on the master (control plane) node as well.</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ kubectl taint nodes --all node-role.kubernetes.io/master-
</code></pre></div><p>In my environment, I did not want to schedule a pod on the master node, so I did not run this.</p>
<p>Now, you have one master (control plane) node (kubeadm init operation) and one worker node (kubeadm join operation) each. The state of the node in my environment is as follows.</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ kubectl get nodes
NAME STATUS ROLES AGE VERSION
jupiter Ready control-plane 109m v1.24.3
saisei Ready &lt;none&gt; 2m42s v1.24.3
</code></pre></div><p>And one more kubeadmin join operation, the status is as follows.</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ kubectl get nodes
NAME STATUS ROLES AGE VERSION
jupiter Ready control-plane 168m v1.24.3
mokusei Ready &lt;none&gt; 2m3s v1.24.3
saisei Ready &lt;none&gt; 62m v1.24.3
</code></pre></div><h4 id="step-4-configure-nvdia-software-with-gpu-operator">Step 4: Configure NVDIA software (with GPU Operator)</h4>
<h5 id="1-install-helm-1">(1) Install helm</h5>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 <span class="se">\
</span><span class="se"></span>&gt; <span class="o">&amp;&amp;</span> chmod <span class="m">700</span> get_helm.sh <span class="se">\
</span><span class="se"></span>&gt; <span class="o">&amp;&amp;</span> . /get_helm.sh
</code></pre></div><h5 id="2-add-nvidia-helm-repository-1">(2) Add NVIDIA Helm repository</h5>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ helm repo add nvidia https://helm.ngc.nvidia.com/nvidia <span class="se">\
</span><span class="se"></span>&gt; <span class="o">&amp;&amp;</span> helm repo update
</code></pre></div><h5 id="3-install-gpu-operator-1">(3) Install GPU Operator</h5>
<p>As mentioned in the overview section, run the &ldquo;Containerd&rdquo; part of &ldquo;Bare-metal/Passthrough with pre-installed drivers and NVIDIA Container Toolkit&rdquo;.</p>
<h6 id="1-edit-configtoml-1">1) Edit config.toml</h6>
<p>Edit /etc/containerd/config.toml as follows</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">79c79
&lt; <span class="nv">default_runtime_name</span> <span class="o">=</span> <span class="s2">&#34;nvida&#34;</span>
---
&gt; <span class="nv">default_runtime_name</span> <span class="o">=</span> <span class="s2">&#34;runc&#34;</span>
125,132d124
&lt; <span class="nv">SystemdCgroup</span> <span class="o">=</span> <span class="nb">true</span>
&lt; <span class="o">[</span>plugins. <span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span>.containerd.runtimes.nvidia<span class="o">]</span>
&lt; <span class="nv">privileged_without_host_devices</span> <span class="o">=</span> <span class="nb">false</span>
&lt; <span class="nv">runtime_engine</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
&lt; <span class="nv">runtime_root</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
&lt; <span class="nv">runtime_type</span> <span class="o">=</span> <span class="s2">&#34;io.containerd.runc.v1&#34;</span>
&lt; <span class="o">[</span>plugins. <span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span>.containerd.runtimes.nvidia.options<span class="o">]</span>
&lt; <span class="nv">BinaryName</span> <span class="o">=</span> <span class="s2">&#34;/usr/bin/nvidia-container-runtime&#34;</span>
</code></pre></div><p>Then restart the containerd daemon.</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ sudo systemctl restart containerd
</code></pre></div><h6 id="2-run-helm-install-1">2) Run helm install</h6>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ helm install --wait --generate-name \
&gt; -n gpu-operator --create-namespace \
&gt; nvidia/gpu-operator \
&gt; --set driver.enabled=false \
&gt; --set toolkit.enabled=false
</code></pre></div><h5 id="4-confirm-gpu-operator-installation-1">(4) Confirm GPU Operator installation</h5>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ kubectl get pods -n gpu-operator
NAME READY STATUS RESTARTS AGE
gpu-operator-1660956347-node-feature-discovery-master-78498fqrv 0/1 ContainerCreating <span class="m">0</span> 22m
gpu-operator-1660956347-node-feature-discovery-worker-d7z25 0/1 ContainerCreating <span class="m">0</span> 66m
gpu-operator-569d9c8cb-r5d6x 0/1 ContainerCreating <span class="m">0</span> 70m
</code></pre></div><p>Compared to the output results from the NVIDIA documentation, there is no pod with nvidia-*.</p>
<h5 id="5-run-sample-gpu-app">(5) Run sample GPU app.</h5>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ cat sample-gpu.yaml
apiVersion: v1
kind: Pod
metadata:
  name: cuda-vectoradd
spec: cuda-vectoradd
  restartPolicy: OnFailure
  containers:
  - name: cuda-vectoradd
    image: <span class="s2">&#34;nvidia/samples:vectoradd-cuda11.2.1&#34;</span>
    resources:
      limits:
         nvidia.com/gpu: <span class="m">1</span>
$ kubectl apply -f sample-gpu.yaml
pod/cuda-vectoradd created
$ kubectl get pod
NAME READY STATUS RESTARTS AGE
cuda-vectoradd 0/1 Pending <span class="m">0</span> 28s
nginx-deployment-6595874d85-88x8d 1/1 Running <span class="m">0</span> 10m
nginx-deployment-6595874d85-nctbg 1/1 Running <span class="m">0</span> 10m
nginx-deployment-6595874d85-v7x4n 1/1 Running <span class="m">0</span> 10m
</code></pre></div><p>As shown above, the sample gpu pod, cuda-vectoradd, is still Pending.</p>
<p>Incidentally, the pod created in <a href="https://kubernetes.io/ja/docs/tasks/run-application/run-stateless-application-deployment/">nginx deployment</a> was in Running status as follows Running status as shown below. (with replicas=3)</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ kubectl apply -f nginx-deployment.yaml
deployment.apps/nginx-deployment created
$ kubectl get pod
NAME READY STATUS RESTARTS AGE
nginx-deployment-6595874d85-88x8d 1/1 Running <span class="m">0</span> 2m55s
nginx-deployment-6595874d85-nctbg 1/1 Running <span class="m">0</span> 2m55s
nginx-deployment-6595874d85-v7x4n 1/1 Running <span class="m">0</span> 2m55s
</code></pre></div><h2 id="summary">Summary</h2>
<p>As explained so far, we have reached the point where we can install kubernetes with kubeadm and build a cluster, but we have not been able to build the GPU cluster, which was our initial goal.
Even after gpu deployment, the pod stays in Pending, not Running state!</p>
<p>Once resolved, I&rsquo;ll re-update the article with the fix.</p>
<p>Translated with <a href="http://www.DeepL.com/Translator">www.DeepL.com/Translator</a> (free version)</p>


        
          <div class="blog-tags">
            
              <a href="https://akenji3.github.io/en/tags/cluster/">cluster</a>&nbsp;
            
              <a href="https://akenji3.github.io/en/tags/kubernetes/">kubernetes</a>&nbsp;
            
              <a href="https://akenji3.github.io/en/tags/gpu/">gpu</a>&nbsp;
            
          </div>
        

        
            <hr/>
            <section id="social-share">
              <div class="list-inline footer-links">
                

<div class="share-box" aria-hidden="true">
    <ul class="share">
      
      <li>
        <a href="//twitter.com/share?url=https%3a%2f%2fakenji3.github.io%2fen%2fpost%2f20220821_kubernetes%2f&amp;text=GPU%20cluster%20construction%20with%20Kubernetes%20%28not%20yet%20completed%29&amp;via=akenji3" target="_blank" title="Share on Twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fakenji3.github.io%2fen%2fpost%2f20220821_kubernetes%2f" target="_blank" title="Share on Facebook">
          <i class="fab fa-facebook"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//reddit.com/submit?url=https%3a%2f%2fakenji3.github.io%2fen%2fpost%2f20220821_kubernetes%2f&amp;title=GPU%20cluster%20construction%20with%20Kubernetes%20%28not%20yet%20completed%29" target="_blank" title="Share on Reddit">
          <i class="fab fa-reddit"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fakenji3.github.io%2fen%2fpost%2f20220821_kubernetes%2f&amp;title=GPU%20cluster%20construction%20with%20Kubernetes%20%28not%20yet%20completed%29" target="_blank" title="Share on LinkedIn">
          <i class="fab fa-linkedin"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.stumbleupon.com/submit?url=https%3a%2f%2fakenji3.github.io%2fen%2fpost%2f20220821_kubernetes%2f&amp;title=GPU%20cluster%20construction%20with%20Kubernetes%20%28not%20yet%20completed%29" target="_blank" title="Share on StumbleUpon">
          <i class="fab fa-stumbleupon"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.pinterest.com/pin/create/button/?url=https%3a%2f%2fakenji3.github.io%2fen%2fpost%2f20220821_kubernetes%2f&amp;description=GPU%20cluster%20construction%20with%20Kubernetes%20%28not%20yet%20completed%29" target="_blank" title="Share on Pinterest">
          <i class="fab fa-pinterest"></i>
        </a>
      </li>
    </ul>
  </div>
  

              </div>
            </section>
        

        
          

          
        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://akenji3.github.io/en/post/20200811_blog_ongithub/" data-toggle="tooltip" data-placement="top" title="Publish a static blog created by Hugo on GitHub Pages">&larr; Previous Post</a>
            </li>
          
          
            <li class="next">
              <a href="https://akenji3.github.io/en/post/20220914_xrandr_badmatch/" data-toggle="tooltip" data-placement="top" title="Change display resolution - xrandr BadMatch support">Next Post &rarr;</a>
            </li>
          
        </ul>
      


      

    </div>
  </div>
</div>

      
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
                <a href="mailto:akenji.1118@gmail.com" title="Email me">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://www.facebook.com/arai.kenji3" title="Facebook">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-facebook fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://github.com/akenji3" title="GitHub">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://twitter.com/akenji3" title="Twitter">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://linkedin.com/in/kenji-arai-0547aa1a4" title="LinkedIn">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
          <li>
            <a href="" title="RSS">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
        <p class="credits copyright text-muted">
          
            
              Kenji Arai
            
          

          &nbsp;&bull;&nbsp;&copy;
          
            2025
          

          
            &nbsp;&bull;&nbsp;
            <a href="https://akenji3.github.io/en/">akenji&#39;s lab</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="https://gohugo.io">Hugo v0.74.3</a> powered &nbsp;&bull;&nbsp; Theme <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a> adapted from <a href="https://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a>
          
        </p>
      </div>
    </div>
  </div>
</footer><script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js" integrity="sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js" integrity="sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<script src="https://akenji3.github.io/js/main.js"></script>
<script src="https://akenji3.github.io/js/highlight.min.js"></script>
<script> hljs.initHighlightingOnLoad(); </script>
<script> $(document).ready(function() {$("pre.chroma").css("padding","0");}); </script><script> renderMathInElement(document.body); </script><script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script><script src="https://akenji3.github.io/js/load-photoswipe.js"></script>








<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$']]
  }
});
</script>


    
  </body>
</html>

